name: Deployment to Andasy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy App
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Andasy CLI
        run: |
          curl -fsSL https://andasy.io/install.sh | bash
          echo "$HOME/.andasy/bin" >> $GITHUB_PATH

      - name: Andasy version
        run: andasy version

      - name: Debug: list orgs and apps
        run: |
          echo "--- andasy status ---"
          ANDASY_ACCESS_TOKEN=${{ secrets.ANDASY_ACCESS_TOKEN }} andasy status || true
          echo "--- orgs ---"
          ANDASY_ACCESS_TOKEN=${{ secrets.ANDASY_ACCESS_TOKEN }} andasy orgs list || true
          echo "--- apps (table) ---"
          ANDASY_ACCESS_TOKEN=${{ secrets.ANDASY_ACCESS_TOKEN }} andasy apps list || true
          echo "--- apps (json) ---"
          ANDASY_ACCESS_TOKEN=${{ secrets.ANDASY_ACCESS_TOKEN }} andasy apps list -j || true

      - name: Deploy to Andasy (CLI)
        env:
          ANDASY_ACCESS_TOKEN: ${{ secrets.ANDASY_ACCESS_TOKEN }}
        run: |
          # deploy the repository root to the 'tartanvolt' app
          andasy deploy -a tartanvolt
